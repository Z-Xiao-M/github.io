<!DOCTYPE html>
<html data-color-mode="light" data-dark-theme="dark-blue" data-light-theme="dark" lang="zh-CN">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href='https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/Primer/21.0.7/primer.css' rel='stylesheet' />
    <script src='https://blog.meekdai.com/Gmeek/plugins/GmeekVercount.js'></script><script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'></script>
    <link rel="icon" href="https://z-xiao-m.github.io/github.io/avatar.svg">
<meta name="description" content="> å¥½å¥½å¥½ï¼Œå¥½ä¹…ä¸è§ï¼Œæœ€è¿‘å¶ç„¶äº†è§£åˆ°äº†pg\_bulkloadè¿™ä¸€æ’ä»¶ï¼Œç„¶åèŠ±äº†ç‚¹æ—¶é—´çœ‹äº†çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Œåˆæƒ³åˆ°å¥½ä¹…æ²¡æœ‰å†™ä¸œè¥¿äº†ï¼Œå’•äº†å¤ªä¹…ï¼Œæœ‰ç‚¹æ€ªä¸å¥½æ„æ€çš„ï¼Œæ‰€ä»¥å†³å®šå†™ç‚¹ä¸œè¥¿ï¼Œæ‘†è„±é¸½å­ğŸ•Šçš„å«Œç–‘ã€‚">
<meta property="og:title" content="èŠèŠpg_bulkloadçš„å¤§æ¦‚çš„å®ç°é€»è¾‘">
<meta property="og:description" content="> å¥½å¥½å¥½ï¼Œå¥½ä¹…ä¸è§ï¼Œæœ€è¿‘å¶ç„¶äº†è§£åˆ°äº†pg\_bulkloadè¿™ä¸€æ’ä»¶ï¼Œç„¶åèŠ±äº†ç‚¹æ—¶é—´çœ‹äº†çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Œåˆæƒ³åˆ°å¥½ä¹…æ²¡æœ‰å†™ä¸œè¥¿äº†ï¼Œå’•äº†å¤ªä¹…ï¼Œæœ‰ç‚¹æ€ªä¸å¥½æ„æ€çš„ï¼Œæ‰€ä»¥å†³å®šå†™ç‚¹ä¸œè¥¿ï¼Œæ‘†è„±é¸½å­ğŸ•Šçš„å«Œç–‘ã€‚">
<meta property="og:type" content="article">
<meta property="og:url" content="https://Z-Xiao-M.github.io/github.io/post/liao-liao-pg_bulkload-de-da-gai-de-shi-xian-luo-ji.html">
<meta property="og:image" content="https://z-xiao-m.github.io/github.io/avatar.svg">
<title>èŠèŠpg_bulkloadçš„å¤§æ¦‚çš„å®ç°é€»è¾‘</title>



</head>
<style>
body{box-sizing: border-box;min-width: 200px;max-width: 900px;margin: 20px auto;padding: 45px;font-size: 16px;font-family: sans-serif;line-height: 1.25;}
#header{display:flex;padding-bottom:8px;border-bottom: 1px solid var(--borderColor-muted, var(--color-border-muted));margin-bottom: 16px;}
#footer {margin-top:64px; text-align: center;font-size: small;}

</style>

<style>
.postTitle{margin: auto 0;font-size:40px;font-weight:bold;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}
#postBody{border-bottom: 1px solid var(--color-border-default);padding-bottom:36px;}
#postBody hr{height:2px;}
#cmButton{height:48px;margin-top:48px;}
#comments{margin-top:64px;}
.g-emoji{font-size:24px;}
@media (max-width: 600px) {
    body {padding: 8px;}
    .postTitle{font-size:24px;}
}
.copy-feedback {
    display: none;
    position: absolute;
    top: 10px;
    right: 50px;
    color: var(--color-fg-on-emphasis);
    background-color: var(--color-fg-muted);
    border-radius: 3px;
    padding: 5px 8px;
    font-size: 12px;
}
</style>
<style>#postBody{font-size:20px}<style>.postTitle{white-space: normal; word-wrap: break-word; max-width: 100%;}</style>



<body>
    <div id="header">
<h1 class="postTitle">èŠèŠpg_bulkloadçš„å¤§æ¦‚çš„å®ç°é€»è¾‘</h1>
<div class="title-right">
    <a href="https://Z-Xiao-M.github.io/github.io" id="buttonHome" class="btn btn-invisible circle" title="é¦–é¡µ">
        <svg class="octicon" width="16" height="16">
            <path id="pathHome" fill-rule="evenodd"></path>
        </svg>
    </a>
    
    <a href="https://github.com/Z-Xiao-M/github.io/issues/14" target="_blank" class="btn btn-invisible circle" title="Issue">
        <svg class="octicon" width="16" height="16">
            <path id="pathIssue" fill-rule="evenodd"></path>
        </svg>
    </a>
    

    <a class="btn btn-invisible circle" onclick="modeSwitch();" title="åˆ‡æ¢ä¸»é¢˜"style="display:none;">
        <svg class="octicon" width="16" height="16" >
            <path id="themeSwitch" fill-rule="evenodd"></path>
        </svg>
    </a>

</div>
</div>
    <div id="content">
<div class="markdown-body" id="postBody"><blockquote>
<p>å¥½å¥½å¥½ï¼Œå¥½ä¹…ä¸è§ï¼Œæœ€è¿‘å¶ç„¶äº†è§£åˆ°äº†pg_bulkloadè¿™ä¸€æ’ä»¶ï¼Œç„¶åèŠ±äº†ç‚¹æ—¶é—´çœ‹äº†çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Œåˆæƒ³åˆ°å¥½ä¹…æ²¡æœ‰å†™ä¸œè¥¿äº†ï¼Œå’•äº†å¤ªä¹…ï¼Œæœ‰ç‚¹æ€ªä¸å¥½æ„æ€çš„ï¼Œæ‰€ä»¥å†³å®šå†™ç‚¹ä¸œè¥¿ï¼Œæ‘†è„±é¸½å­ğŸ•Šçš„å«Œç–‘ã€‚</p>
</blockquote>
<h1>ä¸€ã€pg_bulkloadç®€å•ä»‹ç»</h1>
<p>pg_bulkload ä¸ºPostgreSQLæä¾›é«˜é€ŸåŠ è½½æ•°æ®çš„æ’ä»¶ã€‚ç›¸å…³é“¾æ¥å¦‚ä¸‹ï¼š</p>
<p><a href="https://github.com/ossc-db/pg_bulkload">pg_bulkloadé¡¹ç›®åœ°å€</a></p>
<p><a href="https://ossc-db.github.io/pg_bulkload/pg_bulkload.html" rel="nofollow">pg_bulkloadè¯¦ç»†ä½¿ç”¨æ–‡æ¡£</a></p>
<p><a href="https://ossc-db.github.io/pg_bulkload/index.html" rel="nofollow">copyå‘½ä»¤ä¸pg_bulkloadæ‹“å±•çš„æ€§èƒ½æ¯”è¾ƒ</a></p>
<p>pg_bulkloadå†…éƒ¨ç»“æ„å›¾å¦‚ä¸‹ï¼Œåç»­ç« èŠ‚æˆ‘ä¼šä»¥CSVæ ¼å¼æ–‡ä»¶ï¼Œå¯¹pg_bulkloadè¿›è¡Œåˆ†æï¼Œæºç åˆ†æä»ç¬¬å››èŠ‚å¼€å§‹ï¼Œå¯¹å‰é¢æ¯”è¾ƒç†Ÿæ‚‰çš„åŒå­¦ï¼Œå¯ä»¥ç›´æ¥è°ƒè½¬è‡³ç¬¬å››èŠ‚ã€‚</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/f81fbaeef9a870e139d28e80af6c7ebdfdd2db3820a6df145df70d62fff88d32/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230342d36613531616130382d383032352d343032322d613634322d3965383163376135346238332e706e67"><img src="https://camo.githubusercontent.com/f81fbaeef9a870e139d28e80af6c7ebdfdd2db3820a6df145df70d62fff88d32/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230342d36613531616130382d383032352d343032322d613634322d3965383163376135346238332e706e67" alt="" data-canonical-src="https://oss-emcsprod-public.modb.pro/image/editor/20240204-6a51aa08-8025-4022-a642-9e81c7a54b83.png" style="max-width: 100%;"></a></p>
<h1>äºŒã€æ‹“å±•æ’ä»¶å®‰è£…</h1>
<p>æˆ‘æ­¤æ¬¡é‡‡ç”¨çš„æ˜¯æºç å®‰è£…ï¼ŒPostgreSQLç‰ˆæœ¬14.10ï¼Œä½ å¯ä»¥ç‚¹å‡»ä¸Šè¿°çš„pg_bulkloadé¡¹ç›®åœ°å€ï¼Œä¸‹è½½æºç æ–‡ä»¶ï¼Œæˆ–è€…ä½¿ç”¨git cloneå‘½ä»¤ï¼Œå’Œæˆ‘ä¸€åŒæ“ä½œè¿›è¡Œç¼–è¯‘å®‰è£…ã€‚Â </p>
<pre class="notranslate"><code class="notranslate"># æ‹‰å–pg_bulkloadæºä»£ç 
git clone https://github.com/ossc-db/pg_bulkload.git  
# è¿›å…¥æºç ç›®å½•
cd pg_bulkload/
# å¦‚æœæ­¤æ—¶ä½ çš„æºç ä¸‹è½½è·¯å¾„ä¸æ˜¯ä½äºPostgreSQLæºç çš„contribç›®å½•ä¸‹å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘å®‰è£…
make USE_PGXS=1
make install 
</code></pre>
<p>å¦‚æœæ­¤æ—¶ä½ çš„æºç ä¸‹è½½è·¯å¾„åˆšå¥½æ˜¯ä½äºPostgreSQLçš„contribç›®å½•ä¸‹ æ­¤æ—¶ä½¿ç”¨makeå»ç¼–è¯‘ ä¼šå­˜åœ¨ä¸€ä¸ªç¼–è¯‘çš„é—®é¢˜ ç¼–è¯‘ä¸æˆåŠŸ å¤§è‡´æŠ¥é”™å¦‚ä¸‹ï¼ˆä»…å½“å‰çš„ç‰ˆæœ¬çš„pg_bulkloadï¼‰</p>
<pre class="notranslate"><code class="notranslate">make[1]: --pkglibdir: Command not found
gcc -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror=vla -Wendif-labels -Wmissing-format-attribute -Wimplicit-fallthrough=3 -Wcast-function-type -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -Wno-format-truncation -Wno-stringop-truncation -g -O0 pg_bulkload.o recovery.o pgut/pgut.o pgut/pgut-fe.o pgut/pgut-list.o  -L../../../src/port -L../../../src/common   -Wl,--as-needed -Wl,-rpath,'/var/lib/pgsql/postgresql_14/lib',--enable-new-dtags -Wl,--build-id  -L../../../src/interfaces/libpq -lpq -L -lpgcommon -lpgport -lz -lreadline -lpthread -lrt -ldl -lm -o pg_bulkload
pgut/pgut.o: In function `pgut_init':
/var/lib/pgsql/14code/postgres/contrib/pg_bulkload/bin/pgut/pgut.c:79: undefined reference to `set_pglocale_pgservice'
pgut/pgut.o: In function `prompt_for_password':
/var/lib/pgsql/14code/postgres/contrib/pg_bulkload/bin/pgut/pgut.c:395: undefined reference to `simple_prompt'
pgut/pgut-list.o: In function `new_list':
/var/lib/pgsql/14code/postgres/contrib/pg_bulkload/bin/pgut/pgut-list.c:114: undefined reference to `palloc'
pgut/pgut-list.o: In function `enlarge_list':
/var/lib/pgsql/14code/postgres/contrib/pg_bulkload/bin/pgut/pgut-list.c:174: undefined reference to `repalloc'
pgut/pgut-list.o: In function `list_free_private':
/var/lib/pgsql/14code/postgres/contrib/pg_bulkload/bin/pgut/pgut-list.c:1565: undefined reference to `pfree'
/var/lib/pgsql/14code/postgres/contrib/pg_bulkload/bin/pgut/pgut-list.c:1568: undefined reference to `pfree'
/var/lib/pgsql/14code/postgres/contrib/pg_bulkload/bin/pgut/pgut-list.c:1569: undefined reference to `pfree'
collect2: error: ld returned 1 exit status
make[1]: *** [../../../src/makefiles/pgxs.mk:475: pg_bulkload] Error 1
make[1]: Leaving directory '/var/lib/pgsql/14code/postgres/contrib/pg_bulkload/bin'
make: *** [Makefile:27: all] Error 2
</code></pre>
<p>æ­¤æ—¶éœ€è¦ä¿®æ”¹pg_bulkloadä¸‹binç›®å½•ä¸­çš„Makefile</p>
<pre class="notranslate"><code class="notranslate">cd pg_bulkload/
cd bin/
vim Makefile 
# ä½ å¯ä»¥é€‰æ‹©æ³¨é‡Šæ‰ PG_LIBS += -L$(shell $(PG_CONFIG) --pkglibdir)  æˆ–è€…æ˜¯å°†
# ifdef USE_PGXS
# PG_CONFIG = pg_config
# PGXS := $(shell $(PG_CONFIG) --pgxs)
# æ­¤å¤„çš„PG_CONFIG = pg_config æ”¾åˆ°ifdefå‰ æˆ‘æ›´å€¾å‘äºç¬¬äºŒç§åšæ³•  
# ä¿®æ”¹å®Œæ¯• è¿›è¡Œç¼–è¯‘
make &amp;&amp; make install 
</code></pre>
<p>æˆ‘çš„Makefileä¿®æ”¹å¦‚å›¾æ‰€ç¤º</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/02ac6dcdb3494629a41940688575c05bc63db2b630d05022022cb9c2d852233d/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230342d39353132396363372d626134342d346636382d393363622d3165346462626563643562312e706e67"><img src="https://camo.githubusercontent.com/02ac6dcdb3494629a41940688575c05bc63db2b630d05022022cb9c2d852233d/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230342d39353132396363372d626134342d346636382d393363622d3165346462626563643562312e706e67" alt="" data-canonical-src="https://oss-emcsprod-public.modb.pro/image/editor/20240204-95129cc7-ba44-4f68-93cb-1e4dbbecd5b1.png" style="max-width: 100%;"></a></p>
<p>ç¼–è¯‘å·²é€šè¿‡ã€æ¥ä¸‹æ¥è¿›è¡Œæ’ä»¶å®‰è£…ï¼Œä½¿ç”¨<code class="notranslate">create extension pg_bulkload;</code>å³å¯</p>
<pre class="notranslate"><code class="notranslate">[postgres@halo-centos-8-release ~]$ psql
psql (14.10)
Type "help" for help.

postgres=# create extension pg_bulkload;
CREATE EXTENSION
postgres=# \dx
                                     List of installed extensions
    Name     | Version |   Schema   |                           Description                           
-------------+---------+------------+-----------------------------------------------------------------
 pg_bulkload | 3.1.21  | public     | pg_bulkload is a high speed data loading utility for PostgreSQL
 plpgsql     | 1.0     | pg_catalog | PL/pgSQL procedural language
(2 rows)

postgres=# 
</code></pre>
<h1>ä¸‰ã€ç®€å•ä½¿ç”¨</h1>
<p>å…¶å®æœ‰å¾ˆå¤šå¤§ä½¬å·²ç»ç»™å‡ºäº†éå¸¸è¯¦ç»†çš„ä½¿ç”¨æ–¹å¼äº†ï¼Œæ‰€ä»¥æ­¤å¤„æˆ‘å°±ç®€å•å·´æ‹‰å·´æ‹‰ä¸¤å˜´ã€‚</p>
<pre class="notranslate"><code class="notranslate">-- ä½¿ç”¨haloç”¨æˆ·åœ¨postgresæ•°æ®åº“ä¸‹ åˆ›å»ºè¡¨foo
create table foo(a int, b varchar);
-- é€€å‡ºæ•°æ®åº“
\q
</code></pre>
<p>ç”Ÿæˆç‚¹æ•°æ®</p>
<pre class="notranslate"><code class="notranslate">seq 100000| awk '{print $0",foo"}' &gt; foo.csv
</code></pre>
<p>æ¥ä¸‹æ¥ä½¿ç”¨pg_bulkload å¯¼å…¥æ•°æ®ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ä¸ä½¿ç”¨ctlæ–‡ä»¶</p>
<pre class="notranslate"><code class="notranslate"># æ­¤å¤„è¾“å…¥æ–‡ä»¶ä¸ºfoo.csv è¾“å‡ºå¯¹åº”åˆ°fooè¡¨ æŒ‡å®šç”Ÿæˆæ—¥å¿—ä¸ºtest_foo.log å¤„ç†ä»¥csvçš„å¤„ç†æ–¹å¼å¤„ç†è¾“å…¥æ–‡ä»¶ åˆ†éš”ç¬¦ä¸º"," ç«¯å£å· æ•°æ®åº“å æ“ä½œç”¨æˆ· ä¾æ®è‡ªå·±çš„å®é™…æƒ…å†µè¿›è¡Œæ›´æ”¹ 
[postgres@halo-centos-8-release ~]$ pg_bulkload -i ./foo.csv -O foo -l test_foo.log -p 5434 -o "TYPE=csv" -o "DELIMITER=," -d postgres -U halo
NOTICE: BULK LOAD START
NOTICE: BULK LOAD END
        0 Rows skipped.
        100000 Rows successfully loaded.
        0 Rows not loaded due to parse errors.
        0 Rows not loaded due to duplicate errors.
        0 Rows replaced with new rows.
# æŸ¥çœ‹æ—¥å¿—
[postgres@halo-centos-8-release ~]$ cat test_foo.log

pg_bulkload 3.1.21 on 2024-02-05 10:55:03.159387+08

INPUT = /var/lib/pgsql/foo.csv
PARSE_BADFILE = /var/lib/pgsql/14/pg_bulkload/20240205105503_postgres_public_foo.prs.csv
LOGFILE = /var/lib/pgsql/test_foo.log
LIMIT = INFINITE
PARSE_ERRORS = 0
CHECK_CONSTRAINTS = NO
TYPE = CSV
SKIP = 0
DELIMITER = ,
QUOTE = "\""
ESCAPE = "\""
NULL = 
OUTPUT = public.foo
MULTI_PROCESS = NO
VERBOSE = NO
WRITER = DIRECT
DUPLICATE_BADFILE = /var/lib/pgsql/14/pg_bulkload/20240205105503_postgres_public_foo.dup.csv
DUPLICATE_ERRORS = 0
ON_DUPLICATE_KEEP = NEW
TRUNCATE = NO


  0 Rows skipped.
  100000 Rows successfully loaded.
  0 Rows not loaded due to parse errors.
  0 Rows not loaded due to duplicate errors.
  0 Rows replaced with new rows.

Run began on 2024-02-05 10:55:03.159387+08
Run ended on 2024-02-05 10:55:03.218338+08

CPU 0.00s/0.05u sec elapsed 0.06 sec
</code></pre>
<p><strong>ç¬¬äºŒç§æ˜¯ç¼–å†™ctlæ–‡ä»¶</strong>Â å°†éƒ¨åˆ†éœ€è¦ä¼ å…¥çš„å‚æ•°å†™å…¥ctlæ–‡ä»¶ä¸­</p>
<pre class="notranslate"><code class="notranslate">[postgres@halo-centos-8-release ~]$ vim sample_csv.ctl
[postgres@halo-centos-8-release ~]$ cat sample_csv.ctl
#
# sample_csv.ctl -- Control file to load CSV input data
#
#    Copyright (c) 2007-2024, NIPPON TELEGRAPH AND TELEPHONE CORPORATION
#
OUTPUT = foo                   # [&lt;schema_name&gt;.]table_name
INPUT = /var/lib/pgsql/foo.csv  # Input data location (absolute path)
TYPE = CSV                            # Input file type
QUOTE = "\""                          # Quoting character
ESCAPE = \                            # Escape character for Quoting
DELIMITER = ","                       # Delimiter

[postgres@halo-centos-8-release ~]$ pg_bulkload ./sample_csv.ctl -d postgres -U halo
NOTICE: BULK LOAD START
NOTICE: BULK LOAD END
        0 Rows skipped.
        100000 Rows successfully loaded.
        0 Rows not loaded due to parse errors.
        0 Rows not loaded due to duplicate errors.
        0 Rows replaced with new rows.
[postgres@halo-centos-8-release ~]$ 
</code></pre>
<p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥å°†ctlæ–‡ä»¶å†™çš„æ›´åŠ ä¸°å¯Œè¯¦ç»† æ¯”å¦‚è¯´<strong>æ˜¯å¦åœ¨å¯¼æ•°æ®å‰ æ‰§è¡ŒtruncateÂ  æ˜¯å¦éœ€è¦è·³è¿‡å¤šå°‘è¡Œæ•°æ®Â  å…·ä½“å†™å…¥æ–¹å¼æ˜¯ä»€ä¹ˆ</strong>ä¹‹ç±»çš„ å…·ä½“å¯ä»¥å‚è€ƒ<a href="https://ossc-db.github.io/pg_bulkload/pg_bulkload.html" rel="nofollow">pg_bulkloadè¯¦ç»†ä½¿ç”¨æ–‡æ¡£</a></p>
<pre class="notranslate"><code class="notranslate">[postgres@halo-centos-8-release ~]$ vim sample_csv.ctl 
[postgres@halo-centos-8-release ~]$ cat sample_csv.ctl
OUTPUT = foo                   
INPUT = /var/lib/pgsql/foo.csv 
LOGFILE = /var/lib/pgsql/test_table_foo.log
LIMIT = INFINITE
PARSE_ERRORS = 0
CHECK_CONSTRAINTS = NO
TYPE = CSV
SKIP = 0
DELIMITER = ","
QUOTE = "\""
ESCAPE = "\""
MULTI_PROCESS = NO
WRITER = DIRECT
DUPLICATE_ERRORS = 0
ON_DUPLICATE_KEEP = NEW
TRUNCATE = YES
[postgres@halo-centos-8-release ~]$ pg_bulkload ./sample_csv.ctl -d postgres -U halo
NOTICE: BULK LOAD START
NOTICE: BULK LOAD END
        0 Rows skipped.
        100000 Rows successfully loaded.
        0 Rows not loaded due to parse errors.
        0 Rows not loaded due to duplicate errors.
        0 Rows replaced with new rows.
[postgres@halo-centos-8-release ~]$ cat test_table_foo.log

pg_bulkload 3.1.21 on 2024-02-05 11:58:33.765146+08

INPUT = /var/lib/pgsql/foo.csv
PARSE_BADFILE = /var/lib/pgsql/14/pg_bulkload/20240205115833_postgres_public_foo.prs.csv
LOGFILE = /var/lib/pgsql/test_table_foo.log
LIMIT = INFINITE
PARSE_ERRORS = 0
CHECK_CONSTRAINTS = NO
TYPE = CSV
SKIP = 0
DELIMITER = ,
QUOTE = "\""
ESCAPE = "\""
NULL = 
OUTPUT = public.foo
MULTI_PROCESS = NO
VERBOSE = NO
WRITER = DIRECT
DUPLICATE_BADFILE = /var/lib/pgsql/14/pg_bulkload/20240205115833_postgres_public_foo.dup.csv
DUPLICATE_ERRORS = 0
ON_DUPLICATE_KEEP = NEW
TRUNCATE = YES


  0 Rows skipped.
  100000 Rows successfully loaded.
  0 Rows not loaded due to parse errors.
  0 Rows not loaded due to duplicate errors.
  0 Rows replaced with new rows.

Run began on 2024-02-05 11:58:33.765146+08
Run ended on 2024-02-05 11:58:33.827364+08

CPU 0.01s/0.05u sec elapsed 0.06 sec
</code></pre>
<h1>å››ã€ç®€å•åˆ†æpg_bulkloadç¨‹åº</h1>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥çœ‹çœ‹pg_bulkloadåˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå› æ­¤æˆ‘ä»¬å…ˆæ¥ç…ç…mainå‡½æ•°ï¼ˆç²¾ç®€ç‰ˆæœ¬ï¼‰</p>
<pre class="notranslate"><code class="notranslate">/* main å‡½æ•°ç²¾ç®€ä¹‹åå¤§æ¦‚å°±å¦‚ä¸‹æ‰€ç¤º å¤§æ¦‚äº”ä¸ªéƒ¨åˆ† */
int main(int argc, char *argv[])
{
ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
	pgut_init(argc, argv);
ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
	i = pgut_getopt(argc, argv, options);
	if (recovery)
	{
ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
		return LoaderRecoveryMain();
	}
	else
	{
ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
		if (control_file[0])
			bulkload_options = list_concat(
				ParseControlFile(control_file), bulkload_options);
ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
		return LoaderLoadMain(bulkload_options);
	}
}
</code></pre>
<h2>4.1ã€pgut_init</h2>
<p>åˆå§‹åŒ–å‡½æ•°åšä¸€äº›ç›¸å…³çš„åˆå§‹åŒ–çš„åŠ¨ä½œï¼Œæ³¨æ„äº›å¤„ç†å‡½æ•°ï¼Œæ­¤å¤„ä¸å±•å¼€ã€‚</p>
<h2>4.2ã€pgut_getopt</h2>
<p>è§£æä¼ å…¥çš„å‘½ä»¤è¡Œç›¸å…³é€‰é¡¹ï¼Œæ­¤å‡½æ•°ç²¾ç®€ä¸€ä¸‹ å¦‚ä¸‹æ‰€ç¤º</p>
<pre class="notranslate"><code class="notranslate">int pgut_getopt(int argc, char **argv, pgut_option options[])
{
	/* Help message and version are handled at first. */
ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */

	/* Merge default and user options. */
	longopts = option_merge(default_options, options);
	optstring = longopts_to_optstring(longopts);

	/* Assign named options */
	while ((c = getopt_long(argc, argv, optstring, longopts, &amp;optindex)) != -1)
	{
		opt = option_find(c, default_options, options);
		pgut_setopt(opt, optarg, SOURCE_CMDLINE);
	}
ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
}
</code></pre>
<p>è€Œæ­¤å¤„çš„æ”¯æŒå¤„ç†çš„default_optionså’Œoptionsåˆ†åˆ«æ˜¯</p>
<pre class="notranslate"><code class="notranslate">static pgut_option default_options[] =
{
  { 'b', 'e', "echo"      , &amp;pgut_echo },
  { 'f', 'E', "elevel"    , set_elevel },
  { 's', 'd', "dbname"    , &amp;dbname },
  { 's', 'h', "host"      , &amp;host },
  { 's', 'p', "port"      , &amp;port },
  { 's', 'U', "username"    , &amp;username },
  { 'Y', 'w', "no-password" , &amp;prompt_password },
  { 'y', 'W', "password"    , &amp;prompt_password },
  { 0 }
};

static pgut_option options[] =
{
  /* Dataload options */
  { 's', 'i', "infile"      , &amp;infile },
  { 's', 'i', "input"       , &amp;input },
  { 's', 'O', "output"      , &amp;output },
  { 's', 'l', "logfile"     , &amp;logfile },
  { 's', 'P', "parse-badfile"   , &amp;parse_badfile },
  { 's', 'u', "duplicate-badfile" , &amp;duplicate_badfile },
  { 'f', 'o', "option"      , parse_option },
  /* Recovery options */
  { 's', 'D', "pgdata"      , &amp;DataDir },
  { 'b', 'r', "recovery"      , &amp;recovery },
  { 0 }
};
</code></pre>
<p>å½“ç»è¿‡option_mergeå’Œlongopts_to_optstring æ­¤æ—¶èƒ½å¤Ÿæ”¯æŒå¤„ç†çš„é€‰é¡¹å°±å˜æˆäº†<code class="notranslate">eE:d:h:p:U:wWi:i:O:l:P:u:o:D:r</code></p>
<p>ç„¶åå†é…åˆgetopt_longã€option_findå’Œpgut_setoptå°†ä¼ å…¥çš„ç›¸å…³ä¿¡æ¯ä¿å­˜åˆ°ç¨‹åºä¸­ï¼Œå¦‚<code class="notranslate">pg_bulkload -i ./foo.csv -O foo -l test_foo.log -p 5434 -o "TYPE=csv" -o "DELIMITER=," -d postgres -U halo</code>Â  ä¸­çš„-U haloé€‰é¡¹ï¼Œ</p>
<p>getopt_longå‡½æ•°è¯†åˆ«å¹¶è¿”å›å­—ç¬¦'U'çš„ASCiiç  85</p>
<p>option_findå‡½æ•°æ ¹æ®'U'çš„ASCiiç  æ‰¾åˆ°å¯¹åº”çš„pgut_optionçš„ç»“æ„ä½“å¯¹è±¡</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/0651d94a2e99b5f497c48420d54bfba980baa43aab8cc3ecaa0e40eb4c48f7c3/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230352d38646161656332372d613233392d346436352d623532662d3761356330346266333834392e706e67"><img src="https://camo.githubusercontent.com/0651d94a2e99b5f497c48420d54bfba980baa43aab8cc3ecaa0e40eb4c48f7c3/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230352d38646161656332372d613233392d346436352d623532662d3761356330346266333834392e706e67" alt="" data-canonical-src="https://oss-emcsprod-public.modb.pro/image/editor/20240205-8daaec27-a239-4d65-b52f-7a5c04bf3849.png" style="max-width: 100%;"></a></p>
<p>pgut_setoptå‡½æ•°å†å°†å¯¹åº”çš„varçš„å€¼ ä¹Ÿå°±æ˜¯å¯¹åº”çš„å…¨å±€å˜é‡<strong>username</strong>çš„å€¼ ä¿®æ”¹æˆä¼ å…¥çš„æ•°æ®"halo"ï¼Œå…¶ä»–ä»¥æ­¤ç±»æ¨</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/fa3689bc868b5299064037ca3bd6f34df7b7822b4de046233b641c3c1251831f/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230352d64316531346262622d356364352d346266612d623462362d3866333535356531313938652e706e67"><img src="https://camo.githubusercontent.com/fa3689bc868b5299064037ca3bd6f34df7b7822b4de046233b641c3c1251831f/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230352d64316531346262622d356364352d346266612d623462362d3866333535356531313938652e706e67" alt="" data-canonical-src="https://oss-emcsprod-public.modb.pro/image/editor/20240205-d1e14bbb-5cd5-4bfa-b4b6-8f3555e1198e.png" style="max-width: 100%;"></a></p>
<h2>4.3ã€ParseControlFile</h2>
<p>è§£ææ§åˆ¶æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ctlæ–‡ä»¶ï¼Œå¦‚<code class="notranslate">pg_bulkload ./sample_csv.ctl -d postgres -U halo</code>Â ä¸­çš„sample_csv.ctlæ–‡ä»¶</p>
<p>åœ¨æ‰§è¡ŒParseControlFileå‡½æ•°å‰ å¦‚æœä¸æ˜¯ç»å¯¹è·¯å¾„ ä¼šå…ˆè·å–å®Œæ•´çš„ç»å¯¹è·¯å¾„</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/f843bf94e9101fe07c3cd73520c0c62e6368cf243ab856ba6dbf889364509b64/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230352d61326639663938302d353230652d343366322d386235622d6239336639646537396534662e706e67"><img src="https://camo.githubusercontent.com/f843bf94e9101fe07c3cd73520c0c62e6368cf243ab856ba6dbf889364509b64/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230352d61326639663938302d353230652d343366322d386235622d6239336639646537396534662e706e67" alt="" data-canonical-src="https://oss-emcsprod-public.modb.pro/image/editor/20240205-a2f9f980-520e-43f2-8b5b-b93f9de79e4f.png" style="max-width: 100%;"></a></p>
<p>æ¥ç€å›åˆ°ParseControlFileå‡½æ•° è¾“å…¥å‚æ•°å³ä¸ºä¹‹å‰è·å–åˆ°çš„ç»å¯¹è·¯å¾„</p>
<pre class="notranslate"><code class="notranslate">static List * ParseControlFile(const char *path)
{
       /* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
	file = pgut_fopen(path, "rt");
	for (lineno = 1; fgets(buf, LINEBUF, file); lineno++)
	{
		/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
		for (i = 0; i &lt; NUM_PATH_OPTIONS; i++)
		{
			pgut_option *opt = &amp;options[i];
			if (pgut_keyeq(keyword, opt-&gt;lname))
			{
				pgut_setopt(opt, value, SOURCE_FILE);
				break;
			}
		}

		/* Other options */
		if (i &gt;= NUM_PATH_OPTIONS)
		{
			size_t	len;
			char   *item;
			len = strlen(keyword) + strlen(value) + 2;
			item = pgut_malloc(len);
			snprintf(item, len, "%s=%s", keyword, value);
			items = lappend(items, item);
			if (pg_strcasecmp(item, "TYPE=FUNCTION") == 0)
				type_function = true;
			if (pg_strcasecmp(item, "TYPE=BINARY") == 0 ||
				pg_strcasecmp(item, "TYPE=FIXED") == 0)
				type_binary = true;
			if (pg_strcasecmp(item, "WRITER=BINARY") == 0)
				writer_binary = true;
		}
	}

	fclose(file);
ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
}
</code></pre>
<p>è¿™ä¸ªå‡½æ•°ç”±äºå’Œ<strong>pgut_getopt</strong>Â ç±»ä¼¼ æ‰€ä»¥æåˆ°<strong>LoaderRecoveryMain</strong>å‡½æ•°ä¹‹å‰ ä»–çš„å¤„ç†é€»è¾‘å…¶å®å°±æ˜¯é€šè¿‡fgetså‡½æ•°ä¸€è¡Œä¸€è¡Œçš„è·å–æ•°æ® ç„¶åå»è§£æ æœ€åå’Œ<strong>pgut_getopt</strong>Â  å‡½æ•°ä¸€æ · é€šè¿‡pgut_setoptå»è®¾ç½®ç›¸å…³æ•°æ®</p>
<p>ç”±äº<code class="notranslate">#define NUM_PATH_OPTIONS Â  Â  Â  Â 6</code>æ­¤å¤„ä»–ä»…ä»…åŒ¹é…å¤„ç†è¿™å…­ä¸ªå‚æ•°</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/b56bf4759d60b6cbf4f68f5568b827a42d3dc33854ce94cfb2f7e4e4c3ec80f1/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230352d32323630316333662d353036302d343638392d383335302d6234663261323933383765342e706e67"><img src="https://camo.githubusercontent.com/b56bf4759d60b6cbf4f68f5568b827a42d3dc33854ce94cfb2f7e4e4c3ec80f1/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230352d32323630316333662d353036302d343638392d383335302d6234663261323933383765342e706e67" alt="" data-canonical-src="https://oss-emcsprod-public.modb.pro/image/editor/20240205-22601c3f-5060-4689-8350-b4f2a29387e4.png" style="max-width: 100%;"></a></p>
<p>å½“è¶…è¿‡å…­ä¸ªæ—¶ ä»–ä¼šå½“æˆOther optionså¤„ç†ï¼Œä¼šlappendä¿ç•™ç›¸å…³æ•°æ®ç”¨äºåç»­å¤„ç† åŒæ—¶åˆ¤æ–­å¤„ç†ç±»å‹ æˆ–è€… å†™å…¥æ–¹å¼ï¼Œæ­¤å¤„ä¸æ¶‰åŠ<strong>Recovery options</strong></p>
<h2>4.4ã€LoaderRecoveryMain</h2>
<p>æ­¤å‡½æ•°ç”¨äºè¿›è¡Œæ•°æ®æ¢å¤ï¼Œæœ¬æ¬¡æè¿°ä¸»è¦pg_bulkloadæ˜¯å¦‚ä½•è¿›è¡ŒåŠ è½½æ•°æ®ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹å­¦ä¹ æ­¤å‡½æ•°ã€‚</p>
<h2>4.5ã€LoaderLoadMain</h2>
<p>æ¥åˆ°LoaderLoadMainå‡½æ•°ï¼Œå‰é¢è®²äº†ç›¸å…³çš„å‚æ•°è§£æ ä¸€ç›´éƒ½è¿˜æ²¡åˆ°æœ€ç»ˆå¤„ç† å®˜æ–¹æä¾›çš„pg_bulkloadå†…éƒ¨ç»“æ„å›¾ä¹Ÿå¹¶æ²¡æœ‰å¾—åˆ°ä½“ç° é‚£ä¹ˆpg_bulkloadå†…éƒ¨ç»“æ„å›¾æ˜¯å¦å°±ä½“ç°åœ¨è¿™ä¸ªå‡½æ•°ä¸­å‘¢ï¼Ÿæˆ‘ä»¬æ¥ç€å†æ¥ç…ç…</p>
<pre class="notranslate"><code class="notranslate">static int LoaderLoadMain(List *options)
{
ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
	reconnect(ERROR);

ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
	/* form options as text[] */
	appendStringInfoString(&amp;buf, "{\"");
	foreach (cell, options)
	{
		const char *item = lfirst(cell);

		if (buf.len &gt; 2)
			appendStringInfoString(&amp;buf, "\",\"");

		/* escape " and \ */
		while (*item)
		{
			if (*item == '"' || *item == '\\')
			{
				appendStringInfoChar(&amp;buf, '\\');
				appendStringInfoChar(&amp;buf, *item);
				item++;
			}
			else if (!IS_HIGHBIT_SET(*item))
			{
				appendStringInfoChar(&amp;buf, *item);
				item++;
			}
			else
			{
				int	n = PQmblen(item, encoding);
				appendBinaryStringInfo(&amp;buf, item, n);
				item += n;
			}
		}
	}
	appendStringInfoString(&amp;buf, "\"}");

	command("BEGIN", 0, NULL);
	params[0] = buf.data;
	res = execute("SELECT * FROM pgbulkload.pg_bulkload($1)", 1, params);
	if (PQresultStatus(res) == PGRES_COPY_IN)
	{
		PQclear(res);
		res = RemoteLoad(connection, stdin, type_binary);
		if (PQresultStatus(res) != PGRES_TUPLES_OK)
			elog(ERROR, "copy failed: %s", PQerrorMessage(connection));
	}
	command("COMMIT", 0, NULL);

	errors = atoi(PQgetvalue(res, 0, 2)) +	/* parse errors */
			 atoi(PQgetvalue(res, 0, 3));	/* duplicate errors */

	elog(NOTICE, "BULK LOAD END\n"
				 "\t%s Rows skipped.\n"
				 "\t%s Rows successfully loaded.\n"
				 "\t%s Rows not loaded due to parse errors.\n"
				 "\t%s Rows not loaded due to duplicate errors.\n"
				 "\t%s Rows replaced with new rows.",
				 PQgetvalue(res, 0, 0), PQgetvalue(res, 0, 1),
				 PQgetvalue(res, 0, 2), PQgetvalue(res, 0, 3),
				 PQgetvalue(res, 0, 4));
	PQclear(res);

	disconnect();
	termStringInfo(&amp;buf);

ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯å¦‚æœç®€å•åˆ†æˆä¸‰æ®µçš„è¯ å…¶å®å°±æ˜¯é€šè¿‡reconnectè·å–äº†ä¸€ä¸ªæ–°çš„è¿æ¥Â  ç„¶åæ‰§è¡Œäº†ä¸€ä¸ªåä¸ºpgbulkload.pg_bulkloadçš„æ•°æ®åº“å‡½æ•° å®Œæˆä¹‹åæ‰“å°å‡ºæˆ‘ä»¬ç†Ÿæ‚‰çš„èº«å½±<code class="notranslate">BULK LOAD END ...</code> å¹¶è°ƒç”¨disconnectå…³é—­è¿æ¥ã€‚</p>
<p>è€Œreconnecté€šè¿‡å…ˆå‰è§£æå­˜å‚¨çš„usernameã€dbnameç­‰æ•°æ®é€šè¿‡pgut_connect æœ€åè°ƒç”¨libpqçš„æ¥å£PQconnectdbè·å–åˆ°äº†æ–°çš„è¿æ¥</p>
<pre class="notranslate"><code class="notranslate">void reconnect(int elevel)
{
ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
	if (dbname &amp;&amp; dbname[0])
		escape_param_str(&amp;buf, "dbname", dbname);
	if (host &amp;&amp; host[0])
		escape_param_str(&amp;buf, "host", host);
	if (port &amp;&amp; port[0])
		escape_param_str(&amp;buf, "port", port);
	if (username &amp;&amp; username[0])
		escape_param_str(&amp;buf, "user", username);
	if (password &amp;&amp; password[0])
		escape_param_str(&amp;buf, "password", password);

	connection = pgut_connect(buf.data, prompt_password, elevel); /* pgut_connect --ã€‹conn = PQconnectdb(info); */
ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
}
</code></pre>
<p>é‚£ä¹ˆæˆªè‡³ç›®å‰æˆ‘ä»¬ä¹Ÿå¹¶æ²¡æœ‰çœ‹åˆ°pg_bulkloadå†…éƒ¨ç»“æ„å›¾æœ‰æ‰€ä½“ç°Â  è€Œé€šè¿‡execute--ã€‹pgut_execute--ã€‹pgut_execute_elevel--ã€‹PQexecParamsè°ƒç”¨pgbulkload.pg_bulkloadä¹‹å å°±èƒ½æ‰“å°æœ€ç»ˆçš„å¤„ç†ç»“æœäº† é‚£çœ‹æ ·å­pgbulkload.pg_bulkloadæ‰æ˜¯çœŸæ­£çš„pg_bulkloadç¨‹åº</p>
<p>pgbulkload.pg_bulkloadæ˜¯pg_bulkloadæ’ä»¶ä¸­åˆ›å»ºçš„ä¸€ä¸ªå‡½æ•°ï¼Œåˆ›å»ºè¯­å¥å¦‚ä¸‹ï¼š</p>
<pre class="notranslate"><code class="notranslate">CREATE SCHEMA pgbulkload;

CREATE FUNCTION pgbulkload.pg_bulkload(
	IN options text[],
	OUT skip bigint,
	OUT count bigint,
	OUT parse_errors bigint,
	OUT duplicate_new bigint,
	OUT duplicate_old bigint,
	OUT system_time float8,
	OUT user_time float8,
	OUT duration float8
)
AS '$libdir/pg_bulkload', 'pg_bulkload' LANGUAGE C VOLATILE STRICT;
</code></pre>
<p>Â  è€Œè¿™ä¸€æ®µåˆ™æ˜¯åœ¨æ„é€ pgbulkload.pg_bulkload è¾“å…¥å‚æ•°options text[]</p>
<pre class="notranslate"><code class="notranslate">	/* form options as text[] */
	appendStringInfoString(&amp;buf, "{\"");
	foreach (cell, options)
	{
		const char *item = lfirst(cell);

		if (buf.len &gt; 2)
			appendStringInfoString(&amp;buf, "\",\"");

		/* escape " and \ */
		while (*item)
		{
			if (*item == '"' || *item == '\\')
			{
				appendStringInfoChar(&amp;buf, '\\');
				appendStringInfoChar(&amp;buf, *item);
				item++;
			}
			else if (!IS_HIGHBIT_SET(*item))
			{
				appendStringInfoChar(&amp;buf, *item);
				item++;
			}
			else
			{
				int	n = PQmblen(item, encoding);
				appendBinaryStringInfo(&amp;buf, item, n);
				item += n;
			}
		}
	}
	appendStringInfoString(&amp;buf, "\"}");
</code></pre>
<p>å½“æ‰§è¡Œå®Œä¹‹åSELECT * FROM pgbulkload.pg_bulkloadä¹‹åï¼Œå°±è§£æè¿”å›çš„outå‚æ•°çš„æ•°æ®ï¼Œç„¶åå°±æœ‰äº†ç±»ä¼¼å¦‚ä¸‹çš„æ˜¾ç¤º</p>
<pre class="notranslate"><code class="notranslate">NOTICE: BULK LOAD START
NOTICE: BULK LOAD END
        0 Rows skipped.
        100000 Rows successfully loaded.
        0 Rows not loaded due to parse errors.
        0 Rows not loaded due to duplicate errors.
        0 Rows replaced with new rows.
</code></pre>
<h1>äº”ã€ç®€å•åˆ†æpgbulkload.pg_bulkloadå‡½æ•°</h1>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬ç…ç…pgbulkload.pg_bulkloadå¯¹åº”çš„cå‡½æ•°çš„å…·ä½“å®ç°</p>
<pre class="notranslate"><code class="notranslate">Datum pg_bulkload(PG_FUNCTION_ARGS)
{
	Reader		   *rd = NULL;
	Writer		   *wt = NULL;
ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */

	/*
	 * STEP 1: Initialization
	 */

	/* parse options and create reader and writer */
	ParseOptions(options, &amp;rd, &amp;wt, ru0.tv.tv_sec);

	/* initialize reader */
	ReaderInit(rd);

	/*
	 * We need to split PG_TRY block because gcc optimizes if-branches with
	 * longjmp codes too much. Local variables initialized in either branch
	 * cannot be handled another branch.
	 */
	PG_TRY();
	{
		/* truncate heap */
		if (wt-&gt;truncate)
			TruncateTable(wt-&gt;relid);

		/* initialize writer */
		WriterInit(wt);

		/* initialize checker */
		CheckerInit(&amp;rd-&gt;checker, wt-&gt;rel, wt-&gt;tchecker);

		/* initialize parser */
		ParserInit(rd-&gt;parser, &amp;rd-&gt;checker, rd-&gt;infile, wt-&gt;desc,
				   wt-&gt;multi_process, PG_GET_COLLATION());
	}
	PG_CATCH();
	{
		if (rd)
			ReaderClose(rd, true);
		if (wt)
			WriterClose(wt, true);
		PG_RE_THROW();
	}
	PG_END_TRY();

	/* No throwable codes here! */

	PG_TRY();
	{
		/* create logger */
		CreateLogger(rd-&gt;logfile, wt-&gt;verbose, rd-&gt;infile[0] == ':');

		start = timeval_to_cstring(ru0.tv);
		LoggerLog(INFO, "\npg_bulkload %s on %s\n\n",
				   PG_BULKLOAD_VERSION, start);

		ReaderDumpParams(rd);
		WriterDumpParams(wt);
		LoggerLog(INFO, "\n");

		BULKLOAD_PROFILE(&amp;prof_init);

		/*
		 * STEP 2: Build heap
		 */

		/* Switch into its memory context */
		Assert(wt-&gt;context);
		ctx = MemoryContextSwitchTo(wt-&gt;context);

		/* Loop for each input file record. */
		while (wt-&gt;count &lt; rd-&gt;limit)
		{
			HeapTuple	tuple;

			CHECK_FOR_INTERRUPTS();

			/* read tuple */
			BULKLOAD_PROFILE_PUSH();
			tuple = ReaderNext(rd);
			BULKLOAD_PROFILE_POP();
			BULKLOAD_PROFILE(&amp;prof_reader);
			if (tuple == NULL)
				break;

			/* write tuple */
			BULKLOAD_PROFILE_PUSH();
			WriterInsert(wt, tuple);
			wt-&gt;count += 1;
			BULKLOAD_PROFILE_POP();
			BULKLOAD_PROFILE(&amp;prof_writer);

			MemoryContextReset(wt-&gt;context);
			BULKLOAD_PROFILE(&amp;prof_reset);
		}

		MemoryContextSwitchTo(ctx);

		/*
		 * STEP 3: Finalize heap and merge indexes
		 */

		count = wt-&gt;count;
		parse_errors = rd-&gt;parse_errors;

		/*
		 * close writer first and reader second because shmem_exit callback
		 * is managed by a simple stack.
		 */
		ret = WriterClose(wt, false);
		wt = NULL;
		skip = ReaderClose(rd, false);
		rd = NULL;
	}
	PG_CATCH();
	{
		ErrorData	   *errdata;
		MemoryContext	ecxt;

		ecxt = MemoryContextSwitchTo(ccxt);
		errdata = CopyErrorData();
		LoggerLog(INFO, "%s\n", errdata-&gt;message);
		FreeErrorData(errdata);

		/* close writer first, and reader second */
		if (wt)
			WriterClose(wt, true);
		if (rd)
			ReaderClose(rd, true);

		MemoryContextSwitchTo(ecxt);
		PG_RE_THROW();
	}
	PG_END_TRY();

	count -= ret.num_dup_new;

	LoggerLog(INFO, "\n"
			  "  " int64_FMT " Rows skipped.\n"
			  "  " int64_FMT " Rows successfully loaded.\n"
			  "  " int64_FMT " Rows not loaded due to parse errors.\n"
			  "  " int64_FMT " Rows not loaded due to duplicate errors.\n"
			  "  " int64_FMT " Rows replaced with new rows.\n\n",
			  skip, count, parse_errors, ret.num_dup_new, ret.num_dup_old);

	pg_rusage_init(&amp;ru1);
	system = diffTime(ru1.ru.ru_stime, ru0.ru.ru_stime);
	user = diffTime(ru1.ru.ru_utime, ru0.ru.ru_utime);
	duration = diffTime(ru1.tv, ru0.tv);
	end = timeval_to_cstring(ru1.tv);

	memset(nulls, 0, sizeof(nulls));
	values[0] = Int64GetDatum(skip);
	values[1] = Int64GetDatum(count);
	values[2] = Int64GetDatum(parse_errors);
	values[3] = Int64GetDatum(ret.num_dup_new);
	values[4] = Int64GetDatum(ret.num_dup_old);
	values[5] = Float8GetDatumFast(system);
	values[6] = Float8GetDatumFast(user);
	values[7] = Float8GetDatumFast(duration);

	LoggerLog(INFO,
		"Run began on %s\n"
		"Run ended on %s\n\n"
		"CPU %.2fs/%.2fu sec elapsed %.2f sec\n",
		start, end, system, user, duration);

	LoggerClose();

	result = heap_form_tuple(tupdesc, values, nulls);

	BULKLOAD_PROFILE(&amp;prof_fini);
	BULKLOAD_PROFILE_POP();
	BULKLOAD_PROFILE_PRINT();

	PG_RETURN_DATUM(HeapTupleGetDatum(result));
}
</code></pre>
<p>ä¸éš¾çœ‹å‡ºæ•´ä¸ªå‡½æ•°å°±ä¸‰ä¸ªæ­¥éª¤ï¼Œå¦‚æœé¡ºå¸¦å¯¹åº”ç€pg_bulkloadå†…éƒ¨ç»“æ„å›¾æ¥çœ‹çš„è¯ å…¶å®å°±èƒ½å¾ˆå¥½çš„ç†è§£äº†</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/f81fbaeef9a870e139d28e80af6c7ebdfdd2db3820a6df145df70d62fff88d32/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230342d36613531616130382d383032352d343032322d613634322d3965383163376135346238332e706e67"><img src="https://camo.githubusercontent.com/f81fbaeef9a870e139d28e80af6c7ebdfdd2db3820a6df145df70d62fff88d32/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230342d36613531616130382d383032352d343032322d613634322d3965383163376135346238332e706e67" alt="" data-canonical-src="https://oss-emcsprod-public.modb.pro/image/editor/20240204-6a51aa08-8025-4022-a642-9e81c7a54b83.png" style="max-width: 100%;"></a></p>
<p>æŒ‰ç…§ç»“æ„å›¾æ¥çœ‹å…¶å®å°±åˆ†ä¸ºReaderï¼ŒWriterã€‚ç„¶åReaderçš„Parseræ”¯æŒå¤„ç†ä¸‰ç§ç±»å‹ï¼Œå¦‚æœæ˜¯csvã€binaryè¿™äº›æ ¼å¼ï¼ŒReaderçš„Parserè¿˜ä¼šæ‰¿å½“ä¸€äº›æ£€æŸ¥è½¬æ¢è¿‡æ»¤çš„æ“ä½œï¼Œç„¶åç»è¿‡çº¦æŸæ£€æŸ¥ä¹‹åå°±å¯ä»¥äº¤ç”±Writeräº†ï¼Œè€ŒWriterä¹ŸåŒæ—¶æ”¯æŒä¸‰ç§å¤„ç†ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•ç¡®è®¤Readerçš„Parseræ˜¯å¤„ç†ä»€ä¹ˆç±»å‹çš„ä»¥åŠWriteråº”è¯¥ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼æ’å…¥å‘¢ï¼Ÿæ‰€ä»¥æ•´ä¸ªå·¥ä½œå°±äº¤ç”±äº†Initialization</p>
<h2>5.1ã€Initialization</h2>
<p>å¯¹äºå¦‚ä½•ç¡®è®¤Readerçš„Parseræ˜¯å¤„ç†ä»€ä¹ˆç±»å‹çš„ä»¥åŠWriteråº”è¯¥ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼æ’å…¥å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ParseOptionså‡½æ•°</p>
<pre class="notranslate"><code class="notranslate">	/* parse options and create reader and writer */
	ParseOptions(options, &amp;rd, &amp;wt, ru0.tv.tv_sec);
</code></pre>
<p>å®ƒç”¨äºè§£æå’Œåˆ›å»ºreader and writer å†…éƒ¨è§£æå¤„ç†ä»£ç å¦‚ä¸‹</p>
<pre class="notranslate"><code class="notranslate">	/* parse for each option */
	defs = untransformRelOptions(options);
	foreach (cell, defs)
	{
		opt = lfirst(cell);
		if (opt-&gt;arg == NULL)
			ereport(ERROR, (errcode(ERRCODE_INVALID_PARAMETER_VALUE),
					errmsg("option \"%s\" has no value", opt-&gt;defname)));

		keyword = opt-&gt;defname;
		value = strVal(opt-&gt;arg);

		if (CompareKeyword(keyword, "TYPE"))
		{
			ASSERT_ONCE(type == NULL);
			type = value;
		}
		else if (CompareKeyword(keyword, "WRITER") ||
				 CompareKeyword(keyword, "LOADER"))
		{
			ASSERT_ONCE(writer == NULL);
			writer = value;
		}
		else if (CompareKeyword(keyword, "MULTI_PROCESS"))
		{
			multi_process = ParseBoolean(value);
		}
		else
		{
			rest_defs = lappend(rest_defs, opt);
			continue;
		}
	}

	*wt = WriterCreate(writer, multi_process);
	*rd = ReaderCreate(type);
</code></pre>
<p>å†æ¥çœ‹çœ‹WriterCreateã€ReaderCreate</p>
<pre class="notranslate"><code class="notranslate">Writer *
WriterCreate(char *writer, bool multi_process)
{
	const char *keys[] =
	{
		"DIRECT",
		"BUFFERED",
		"BINARY"
	};
	const CreateWriter values[] =
	{
		CreateDirectWriter,
		CreateBufferedWriter,
		CreateBinaryWriter
	};

	Writer *self;

	/* default of writer is DIRECT */
	if (writer == NULL)
		writer = "DIRECT";

	/* alias for backward compatibility. */
	if (pg_strcasecmp(writer, "PARALLEL") == 0)
	{
		multi_process = true;
		writer = "DIRECT";
	}

	self = values[choice("WRITER", writer, keys, lengthof(keys))](NULL);

	if (multi_process)
		self = CreateParallelWriter(self);

	self-&gt;multi_process = multi_process;

	return self;
}


Reader *
ReaderCreate(char *type)
{
	const char *keys[] =
	{
		"BINARY",
		"FIXED",	/* alias for backward compatibility. */
		"CSV",
		"TUPLE",
		"FUNCTION",
	};
	const ParserCreate values[] =
	{
		CreateBinaryParser,
		CreateBinaryParser,
		CreateCSVParser,
		CreateTupleParser,
		CreateFunctionParser,
	};

	Reader	   *self;

	/* default of type is CSV */
	if (type == NULL)
		type = "CSV";

	self = palloc0(sizeof(Reader));
	self-&gt;max_parse_errors = -2;
	self-&gt;limit = INT64_MAX;
	self-&gt;checker.encoding = -1;

	self-&gt;parser = values[choice("TYPE", type, keys, lengthof(keys))]();

	return self;
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°å®Œå®Œå…¨å…¨å’Œç»“æ„å›¾å¯¹åº”ä¸Šäº†ï¼Œå†å¤šçš„å†…å®¹å°±ä¸å±•å¼€äº†ï¼Œåç»­å°±æ˜¯å¯¹åº”çš„åˆå§‹åŒ–æŒ‡é’ˆåˆå§‹åŒ–readerï¼ˆparserã€checkerï¼‰ã€writer ï¼Œå¦‚æœæ˜¯è®¾ç½®äº†å¯¼æ•°æ®å‰å…ˆtruncate ä¹Ÿæ˜¯åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰§è¡Œçš„ ï¼Œä»¥åŠåˆ›å»ºå¯¹åº”çš„logger ç”¨äºè¾“å‡ºæ—¥å¿—</p>
<pre class="notranslate"><code class="notranslate">	/* initialize reader */
	ReaderInit(rd);

	/*
	 * We need to split PG_TRY block because gcc optimizes if-branches with
	 * longjmp codes too much. Local variables initialized in either branch
	 * cannot be handled another branch.
	 */
	PG_TRY();
	{
		/* truncate heap */
		if (wt-&gt;truncate)
			TruncateTable(wt-&gt;relid);

		/* initialize writer */
		WriterInit(wt);

		/* initialize checker */
		CheckerInit(&amp;rd-&gt;checker, wt-&gt;rel, wt-&gt;tchecker);

		/* initialize parser */
		ParserInit(rd-&gt;parser, &amp;rd-&gt;checker, rd-&gt;infile, wt-&gt;desc,
				   wt-&gt;multi_process, PG_GET_COLLATION());
	}
	PG_CATCH();
	{
		if (rd)
			ReaderClose(rd, true);
		if (wt)
			WriterClose(wt, true);
		PG_RE_THROW();
	}
	PG_END_TRY();
 
ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€/* ...çœç•¥éƒ¨åˆ†ä»£ç ... */
		/* create logger */
		CreateLogger(rd-&gt;logfile, wt-&gt;verbose, rd-&gt;infile[0] == ':');

		start = timeval_to_cstring(ru0.tv);
		LoggerLog(INFO, "\npg_bulkload %s on %s\n\n",
				   PG_BULKLOAD_VERSION, start);

		ReaderDumpParams(rd);
		WriterDumpParams(wt);
		LoggerLog(INFO, "\n");
</code></pre>
<h2>5.2ã€Build heap</h2>
<p>è¿™ä¸ªéƒ¨åˆ†çš„ä»£ç å¾ˆæ¸…æ™°ï¼Œè¿™ä¸ªé˜¶æ®µå°±æ˜¯ç”±Readerè¯»å–è§£ææ•°æ®ç”Ÿæˆå…ƒç»„ï¼ˆå…³ç³»å‹æ•°æ®åº“çš„åŸºç¡€æ¦‚å¿µï¼‰æ£€æŸ¥æ ¡éªŒå®Œä¹‹å ç„¶åäº¤ç”±Writerä½¿ç”¨æŒ‡å®šçš„æ–¹å¼æ’å…¥æŒ‡å®šçš„è¡¨ä¸­</p>
<pre class="notranslate"><code class="notranslate">		/* Loop for each input file record. */
		while (wt-&gt;count &lt; rd-&gt;limit)
		{
			HeapTuple	tuple;

			CHECK_FOR_INTERRUPTS();

			/* read tuple */
			BULKLOAD_PROFILE_PUSH();
			tuple = ReaderNext(rd);
			BULKLOAD_PROFILE_POP();
			BULKLOAD_PROFILE(&amp;prof_reader);
			if (tuple == NULL)
				break;

			/* write tuple */
			BULKLOAD_PROFILE_PUSH();
			WriterInsert(wt, tuple);
			wt-&gt;count += 1;
			BULKLOAD_PROFILE_POP();
			BULKLOAD_PROFILE(&amp;prof_writer);

			MemoryContextReset(wt-&gt;context);
			BULKLOAD_PROFILE(&amp;prof_reset);
		}
</code></pre>
<p>ReaderNextå‡½æ•°</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/422db99593a51c501b6b6f7e2569c81ca325f462b8a5025702d59839e80dff92/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230362d31343764666263612d346564352d343834332d383535642d6430666635623966373264352e706e67"><img src="https://camo.githubusercontent.com/422db99593a51c501b6b6f7e2569c81ca325f462b8a5025702d59839e80dff92/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230362d31343764666263612d346564352d343834332d383535642d6430666635623966373264352e706e67" alt="" data-canonical-src="https://oss-emcsprod-public.modb.pro/image/editor/20240206-147dfbca-4ed5-4843-855d-d0ff5b9f72d5.png" style="max-width: 100%;"></a></p>
<h2>5.3ã€Finalize heap and merge indexes</h2>
<p>è¿™ä¸€éƒ¨åˆ†å°±æ˜¯å®Œæˆå¯¹writerã€readerçš„æ¸…ç†ã€è®°å½•ä¸€äº›æ—¥å¿—æ•°æ®ã€è¿˜æœ‰ä¸€æ­¥å°±æ˜¯ç”Ÿæˆæœ€ç»ˆçš„è¿”å›å…ƒç»„ï¼Œå®Œæˆå‡½æ•°è°ƒç”¨ï¼Œå°±æ­¤é—­ç¯äº†ã€‚</p>
<pre class="notranslate"><code class="notranslate">		/* close writer first, and reader second */
		if (wt)
			WriterClose(wt, true);
		if (rd)
			ReaderClose(rd, true)

	LoggerLog(INFO, "\n"
			  "  " int64_FMT " Rows skipped.\n"
			  "  " int64_FMT " Rows successfully loaded.\n"
			  "  " int64_FMT " Rows not loaded due to parse errors.\n"
			  "  " int64_FMT " Rows not loaded due to duplicate errors.\n"
			  "  " int64_FMT " Rows replaced with new rows.\n\n",
			  skip, count, parse_errors, ret.num_dup_new, ret.num_dup_old);

	pg_rusage_init(&amp;ru1);
	system = diffTime(ru1.ru.ru_stime, ru0.ru.ru_stime);
	user = diffTime(ru1.ru.ru_utime, ru0.ru.ru_utime);
	duration = diffTime(ru1.tv, ru0.tv);
	end = timeval_to_cstring(ru1.tv);

	memset(nulls, 0, sizeof(nulls));
	values[0] = Int64GetDatum(skip);
	values[1] = Int64GetDatum(count);
	values[2] = Int64GetDatum(parse_errors);
	values[3] = Int64GetDatum(ret.num_dup_new);
	values[4] = Int64GetDatum(ret.num_dup_old);
	values[5] = Float8GetDatumFast(system);
	values[6] = Float8GetDatumFast(user);
	values[7] = Float8GetDatumFast(duration);

	LoggerLog(INFO,
		"Run began on %s\n"
		"Run ended on %s\n\n"
		"CPU %.2fs/%.2fu sec elapsed %.2f sec\n",
		start, end, system, user, duration);

	LoggerClose();

	result = heap_form_tuple(tupdesc, values, nulls);

	BULKLOAD_PROFILE(&amp;prof_fini);
	BULKLOAD_PROFILE_POP();
	BULKLOAD_PROFILE_PRINT();

	PG_RETURN_DATUM(HeapTupleGetDatum(result));
</code></pre>
<p>å…­ã€æ€»ç»“</p>
<p>=======</p>
<p>æ¥ä¸ªç®€å•çš„æ€»ç»“ åªæ˜¯æ¢³ç†äº†ä¸€ä¸‹Â pg_bulkloadå¤§æ¦‚çš„åŠ è½½æ•°æ®çš„è¿‡ç¨‹ å…·ä½“ç»†èŠ‚æ–¹é¢ å„ä½å¯ä»¥è‡ªè¡Œè°ƒè¯•ã€‚</p>
<p>å¯¹äºpg_bulkloadç¨‹åºè€Œè¨€ï¼Œ</p>
<p>ä¸»è¦å°±æ˜¯ä¾æ®è§£æåˆ°çš„ä¿¡æ¯åˆ›å»ºæ•°æ®åº“è¿æ¥ï¼Œ</p>
<p>æ‰§è¡Œ<code class="notranslate">SELECT * FROM pgbulkload.pg_bulkload($1)</code>Â </p>
<p>è§£æè¿”å›æ•°æ® å…³é—­è¿æ¥</p>
<p>å…¶å®ä¸»è¦å°±æ˜¯è°ƒç”¨pgbulkload.pg_bulkloadæ•°æ®åº“å‡½æ•°ï¼Œå’Œç»™å‡ºçš„pg_bulkloadå†…éƒ¨ç»“æ„å›¾æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„å…³ç³»ï¼Œ</p>
<p>æˆ–è€…æ˜¯è¯´pgbulkload.pg_bulkloadå¯¹åº”çš„cå‡½æ•°æ‰æ˜¯çœŸæ­£çš„æ„ä¹‰ä¸Šçš„"pg_bulkload"ç¨‹åºã€‚</p>
<p>æ­¤å¤„ç»™å‡ºpg_bulkloadç¨‹åºçš„ä¸€ä¸ªå¤§æ¦‚çš„æ‰§è¡Œæµç¨‹å›¾</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/ed15104e8eae43aa04cd92468983e0b2041e5005b31c0b7f5780c784a27045df/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230362d66623962613334642d376561382d343136302d386262392d6432393535636466623233312e706e67"><img src="https://camo.githubusercontent.com/ed15104e8eae43aa04cd92468983e0b2041e5005b31c0b7f5780c784a27045df/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230362d66623962613334642d376561382d343136302d386262392d6432393535636466623233312e706e67" alt="" data-canonical-src="https://oss-emcsprod-public.modb.pro/image/editor/20240206-fb9ba34d-7ea8-4160-8bb9-d2955cdfb231.png" style="max-width: 100%;"></a></p>
<p>æ­¤å¤„ç»™å‡ºpgbulkload.pg_bulkloadæ•°æ®åº“å†…æ ¸cå‡½æ•°çš„ä¸€ä¸ªå¤§æ¦‚çš„æ‰§è¡Œæµç¨‹å›¾</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/f40870e585fe58ce73e3ecb0ca35af64c4da28a58a83c2df2844f2ada51b21c0/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230362d38303636646664632d373433622d343363622d383932362d3236333462306530633064392e706e67"><img src="https://camo.githubusercontent.com/f40870e585fe58ce73e3ecb0ca35af64c4da28a58a83c2df2844f2ada51b21c0/68747470733a2f2f6f73732d656d637370726f642d7075626c69632e6d6f64622e70726f2f696d6167652f656469746f722f32303234303230362d38303636646664632d373433622d343363622d383932362d3236333462306530633064392e706e67" alt="" data-canonical-src="https://oss-emcsprod-public.modb.pro/image/editor/20240206-8066dfdc-743b-43cb-8926-2634b0e0c0d9.png" style="max-width: 100%;"></a></p>
<h1>ä¸ƒã€å£°æ˜</h1>
<p>ç”±äºç¯‡å¹…çš„åŸå› è¯¸å¤šç»†èŠ‚æœªå®Œå…¨å±•å¼€ï¼ˆåˆæ˜¯å†—é•¿çš„ä¸€ç¯‡...Â  è¿™ä¸ªç¯‡å¹…è¿˜çœŸæ˜¯æœ‰ç‚¹ä¸å¥½æ§åˆ¶ï¼‰ï¼Œè‹¥æ–‡ä¸­å­˜åœ¨é”™è¯¯æˆ–ä¸å½“ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡å‡ºï¼Œä»¥ä¾¿æˆ‘è¿›è¡Œä¿®æ­£å’Œå®Œå–„ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿå¸®åŠ©åˆ°ä½ ã€‚</p>
<p>æ–‡ç« è½¬è½½è¯·è”ç³»ï¼Œè°¢è°¢åˆä½œã€‚</p></div>
<div style="font-size:small;margin-top:8px;float:right;">â¤ï¸ è½¬è½½æ–‡ç« è¯·æ³¨æ˜å‡ºå¤„ï¼Œè°¢è°¢ï¼â¤ï¸</div>

<button class="btn btn-block" type="button" onclick="openComments()" id="cmButton">è¯„è®º</button>
<div class="comments" id="comments"></div>

</div>
    <div id="footer"><div id="footer1">Copyright Â© <span id="copyrightYear"></span> <a href="https://Z-Xiao-M.github.io/github.io">åŒ…é‡Œè£…ç€ä¸ªå¡æ¯”å…½</a></div>
<div id="footer2">
    <span id="runday"></span><span>Powered by <a href="https://meekdai.com/Gmeek.html" target="_blank">Gmeek</a></span>
</div>

<script>
var now=new Date();
document.getElementById("copyrightYear").innerHTML=now.getFullYear();

if("08/31/2025"!=""){
    var startSite=new Date("08/31/2025");
    var diff=now.getTime()-startSite.getTime();
    var diffDay=Math.floor(diff/(1000*60*60*24));
    document.getElementById("runday").innerHTML="ç½‘ç«™è¿è¡Œ"+diffDay+"å¤©"+" â€¢ ";
}
</script></div>
</body>
<script>
var IconList={'sun': 'M8 10.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zm0 13a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 13zM2.343 2.343a.75.75 0 011.061 0l1.06 1.061a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zm9.193 9.193a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061l-1.061-1.06a.75.75 0 010-1.061zM16 8a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm10.657-5.657a.75.75 0 010 1.061l-1.061 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0z', 'moon': 'M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z', 'sync': 'M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z', 'home': 'M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z', 'github': 'M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z', 'copy': 'M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z', 'check': 'M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z'};
var utterancesLoad=0;

console.log("\n %c Gmeek last https://github.com/Meekdai/Gmeek \n","padding:5px 0;background:#02d81d;color:#fff");
</script>

<script>
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
document.getElementById("pathIssue").setAttribute("d",IconList["github"]);



function openComments(){
    cm=document.getElementById("comments");
    cmButton=document.getElementById("cmButton");
    cmButton.innerHTML="loading";
    span=document.createElement("span");
    span.setAttribute("class","AnimatedEllipsis");
    cmButton.appendChild(span);

    script=document.createElement("script");
    script.setAttribute("src","https://utteranc.es/client.js");
    script.setAttribute("repo","Z-Xiao-M/github.io");
    script.setAttribute("issue-term","title");
    
    script.setAttribute("theme","dark-blue");
    
    script.setAttribute("crossorigin","anonymous");
    script.setAttribute("async","");
    cm.appendChild(script);

    int=self.setInterval("iFrameLoading()",200);
}

function iFrameLoading(){
    var utterances=document.getElementsByClassName('utterances');
    if(utterances.length==1){
        if(utterances[0].style.height!=""){
            utterancesLoad=1;
            int=window.clearInterval(int);
            document.getElementById("cmButton").style.display="none";
            console.log("utterances Load OK");
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const createClipboardHTML = (codeContent, additionalClasses = '') => `
        <pre class="notranslate"><code class="notranslate">${codeContent}</code></pre>
        <div class="clipboard-container position-absolute right-0 top-0 ${additionalClasses}">
            <clipboard-copy class="ClipboardButton btn m-2 p-0" role="button" style="display: inherit;">
                <svg height="16" width="16" class="octicon octicon-copy m-2"><path d="${IconList["copy"]}"></path></svg>
                <svg height="16" width="16" class="octicon octicon-check color-fg-success m-2 d-none"><path d="${IconList["check"]}"></path></svg>
            </clipboard-copy>
            <div class="copy-feedback">Copied!</div>
        </div>
    `;

    const handleCodeElements = (selector = '') => {
        document.querySelectorAll(selector).forEach(codeElement => {
            const codeContent = codeElement.innerHTML;
            const newStructure = document.createElement('div');
            newStructure.className = 'snippet-clipboard-content position-relative overflow-auto';
            newStructure.innerHTML = createClipboardHTML(codeContent);

            const parentElement = codeElement.parentElement;
            if (selector.includes('highlight')) {
                parentElement.insertBefore(newStructure, codeElement.nextSibling);
                parentElement.removeChild(codeElement);
            } else {
                parentElement.parentElement.replaceChild(newStructure, parentElement);
            }
        });
    };

    handleCodeElements('pre.notranslate > code.notranslate');
    handleCodeElements('div.highlight > pre.notranslate');

    let currentFeedback = null;
    document.querySelectorAll('clipboard-copy').forEach(copyButton => {
        copyButton.addEventListener('click', () => {
            const codeContent = copyButton.closest('.snippet-clipboard-content').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = codeContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            const copyIcon = copyButton.querySelector('.octicon-copy');
            const checkIcon = copyButton.querySelector('.octicon-check');
            const copyFeedback = copyButton.nextElementSibling;

            if (currentFeedback && currentFeedback !== copyFeedback) {currentFeedback.style.display = 'none';}
            currentFeedback = copyFeedback;

            copyIcon.classList.add('d-none');
            checkIcon.classList.remove('d-none');
            copyFeedback.style.display = 'block';
            copyButton.style.borderColor = 'var(--color-success-fg)';

            setTimeout(() => {
                copyIcon.classList.remove('d-none');
                checkIcon.classList.add('d-none');
                copyFeedback.style.display = 'none';
                copyButton.style.borderColor = '';
            }, 2000);
        });
    });
});

</script>


</html>
